{% extends 'base.html' %}

{% block title %}{{ room_name }} | {% endblock %}

{% block view_title %}
    {{room_name}}
{% endblock %}

{% load static %}

{% block content %}

<head>
    <style>
        .chat-messages {
            height: 700px;
            overflow-y: auto;
        }
    </style>
    <script src="https://open.spotify.com/embed-album/iframe-api/v1" async></script>
</head>

<body>
    <div class="container">
        <center>
            <iframe style="border-radius:12px"
                src="https://open.spotify.com/embed/album/{{ album }}?utm_source=generator" width="100%"
                height="100" frameBorder="0" allowfullscreen=""
                allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
            </center>
            <br/>
        <div class="row d-flex justify-content-center">
            <div class="col-12">
                <div class="card">
                <form onsubmit="return messageSubmit()">
                    <div class="card-body pb-0" data-simplebar style="height: 545px">
                    <div class="form-group">
                        <div class="lg:w-2/4 rounded-xl">
                            <div class="chat-messages space-y-3" id="chat-messages"></div>
                        </div>
                    </div>
                </div>
                <hr/>
                <div class="card-body pt-0 pb-0">
                    <div class="input-group input-group-chat p-0 mb-3">
                        <div class="input-group-prepend">
                            <span class="emoticon-icon mdi mdi-emoticon-happy-outline"></span>
                          </div>
                        <input class="form-control" id="input" type="text" placeholder="Your message here..."></br>
                        <div class="input-group-append">
                            <button class="btn btn-secondary" id="submit" type="button">Send</button>
                        </div>
                    </div>
                </div>
                </form>
            </div>
            </div>
        </div>

        {{ slug|json_script:"json_name" }}
        {{ room_name|json_script:"json_room_name"}}
        {{ request.user.username|json_script:"json_user"}}
        <script>
            const roomName = JSON.parse(document.getElementById('json_room_name').textContent);
            const user_username = JSON.parse(document.getElementById('json_user').textContent);
            const roomSlug = JSON.parse(document.getElementById('json_name').textContent);
            var ws_scheme = window.location.protocol == "https:" ? "wss://" : "ws://";

            const chatSocket = new WebSocket(
                ws_scheme +
                window.location.host +
                '/ws/l_room/' +
                roomSlug +
                '/'
            );

            document.querySelector('#submit').onclick = function (e) {
                e.preventDefault();
                messageSubmit();
            };

            function messageSubmit(){
                const messageInputDom = document.querySelector('#input');
                const message = messageInputDom.value;
                chatSocket.send(JSON.stringify({
                    'message': message,
                    'username': user_username,

                }));
                messageInputDom.value = '';
                return false;
            }



            chatSocket.onmessage = function (e) {
                const data = JSON.parse(e.data);
                if (data.message) {
                    let html = '<div class="media media-chat">';
                        html += `<img src="{% static 'images/user/user-sm-01.jpg' %}" class="rounded-circle" alt="Avata Image">`
                        html += '<div class="media-body"><div class="text-content">';
                    html += '<p class="font-bold" style="font-size:125%; color:black;"><b>' + data.username + '</b></p>';
                    html += '<p style="color:black">' + data.message + '</p>'
                    html += `<time class="time">${data.timestamp}` 
                    html += '</time></div></div></div></br>';
                    document.querySelector('#chat-messages').innerHTML += html;
                    scrollToBottom();
                } else {
                    alert('The message is empty');
                }
            };

            function scrollToBottom() {
                const objDiv = document.querySelector('#chat-messages');
                objDiv.scrollTop = objDiv.scrollHeight;
            }
            scrollToBottom();
        </script>
</body>
{% endblock %}